
### КОМАНДЫ В КОНСОЛИ


```python
#подключиться к bd-master

$ ssh -i ./newprolab.pem maksim.kobzev@bd-master.newprolab.com

#убедиться, что таблицы не существует (если существует - делаем disable, потом drop и создаем заново) и создать новую

$ echo 'describe "maksim.kobzev"' | hbase shell -n
$ echo "create 'maksim.kobzev', {NAME => ‘data’, VERSIONS => 4096}" | hbase shell -n

#создать фалы mapper.py и reducer.py в домашней директории (у меня это была './test') и сделать их исполняемыми (код для обоих файлов ниже)
$ nano ./test/mapper.py #скопировать и вставить код из блока mapper ниже
$ nano ./test/reducer.py #скопировать и вставить код из блока reducer ниже
$ chmod +x ./test/mapper.py
$ chmod +x ./test/reducer.py

#запустить MR job. Важно помнить, что аргумент -file принимает путь к файлам относительно домашней директории а не на хадупе!
hadoop jar ~/hadoop-streaming.jar -D mapred.reduce.tasks=1 -input /labs/lab02data/facetz_2015_02_15/part* -output /tmp/maksim.kobzev/r12/ -file ./test/mapper.py -file ./test/reducer.py -mapper "./mapper.py" -reducer "./reducer.py"
```

### MAPPER


```python
#mapper - сохранить этот блок в отдельный файл с названием mapper.py
#принимаем на стандартный вход содержимое файлов из директории-источника и результат выводим построчно на стандартный выход
#!/opt/anaconda/envs/bd9/bin/python
import sys
for line in sys.stdin:
    # Лучше повторяемые участки кода всегда выносить в отдельные переменные\функции.
    # В данном случае оптимально было бы сделать какую-то переменную, которой присводить заспличенную строку, например:
    # row = line.strip().split('\t')
    # Во-первых, это сделает дальнейший код более читаемым, во-вторых, это одна из самых простых оптимзаций. 
    # В твоем случае сплит вызывается каждый раз (вместо одного) и тратиться процессорное время.
    # На больших данных это может дать весомую прибавку ко времени выполнеия.
    
    # Лучше все-таки вынести UID, timestamp и url в отдельные переменные:
    # uid, timestamp, url = row
    # Это повысило бы читабельность кода и упростило бы дальнейшую поддержку. 
    # Представь, если какой-то другой разработчик прочитает твой код - ему будет трудно
    # только по индексам лразобраться какие преобразования над какими данными производятся
    if len(line.strip().split('\t')) != 3\
    or line.strip().split('\t')[0] == '-'\
    
    # Тут использутеся приведение типов, поэтому лучше добавить блок try-except для обработки исключений
    # Еще хорошая практика константы выносить в начало скрипта
    or int(line.strip().split('\t')[0]) % 256 != 42\

    # Для проверки того, что строка начинается с какого-то префикса можно также использовать метод url.startswith('http')
    or line.strip().split('\t')[2][:4] != 'http':
        continue

    # Тут также все хорошо, но, возможно, стоит пресмотреться к форматируемым строкам
    # Либо как мы делали на лекции через метод '{}\t{}\t{}'.format(uid, timestamp, url)
    # либо через f'{uid}\t{timestamp}\t{url}'
    print(line.strip().split('\t')[0] + '\t' +\
          str(int(float(line.strip().split('\t')[1])*1000)) + '\t' +\
          line.strip().split('\t')[2])

# На будущее, лучше всё-таки код цикла завернуть в какую-то функцию map() и вызывать этот map следующим образом:
# if __name__ == '__main__':
#     map()
# Конструкция выше отрабатывает следующим образом. Когда ты вызываешь код напрямую из интерпретатора (как раз наш случай),
# то переменная __name__ как раз будет равно '__main__'. То есть вызовется твой map() и разницы с текущией реализацией 
# не будет.
# Разница появится, если твой маппер захочет кто-то переиспользовать в своем проекте и сделает import "mapper.py".
# В текущей реализации весь твой код сразу выполнится при вызове import, а, скорее всего, этого не очень хочется :)
# Если не очень понятно объяснил, то могу поробовать в ЛС еще объяснить :)

```

### REDUCER


```python
#reducer - сохранить этот блок в отдельный файл с названием reducer.py
#принимаем на вход строки с uid, url и timestamp и заливаем построчно в hbase, используя библиотеку happybase
#!/opt/anaconda/envs/bd9/bin/python
import sys
import happybase

# Здесь также имеет смысл константы вынести в отдельные переменные
connection = happybase.Connection('bd-node2.newprolab.com')
table = connection.table(b'maksim.kobzev')

for line in sys.stdin:
    table.put(line.strip().split('\t')[0],\
              {b'data:url': str(line.strip().split('\t')[2])},\
              timestamp=int(line.strip().split('\t')[1]))
connection.close()

# Ну и так же, как я писал в комментарии к мапперу, лучше добавить конструкцию:
# if __name__ == '__main__': 
#     reduce()
```

PS. На самом деле каких-то критичных замечаний нет, но я сам не python-разработчик :) Если есть какие-то вопросы, то можем в ЛС обсудить.
